name: CI

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: read
  packages: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.detect.outputs.apps }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed apps
        id: detect
        run: |
          # For push events, compare HEAD~1 to HEAD (previous commit)
          # For PR events, compare against origin/main
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_APPS=$(git diff --name-only HEAD~1 HEAD \
                          | grep '^apps/' \
                          | cut -d/ -f2 \
                          | sort -u)
          else
            CHANGED_APPS=$(git diff --name-only origin/main HEAD \
                          | grep '^apps/' \
                          | cut -d/ -f2 \
                          | sort -u)
          fi
          if [ -z "$CHANGED_APPS" ]; then
            echo "apps=[]" >> $GITHUB_OUTPUT
          else
            # Build JSON array manually to avoid jq whitespace issues
            MATRIX="["
            FIRST=true
            while IFS= read -r app; do
              if [ "$FIRST" = true ]; then
                MATRIX="${MATRIX}\"${app}\""
                FIRST=false
              else
                MATRIX="${MATRIX},\"${app}\""
              fi
            done <<< "$CHANGED_APPS"
            MATRIX="${MATRIX}]"
            echo "apps=${MATRIX}" >> $GITHUB_OUTPUT
          fi

  # PR workflow: single-arch build + test, no push (cheap)
  pr-validate:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.apps != '[]'
    strategy:
      fail-fast: false
      matrix:
        app: ${{fromJson(needs.detect-changes.outputs.apps)}}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (single-arch, no push)
        uses: docker/build-push-action@v6
        with:
          context: apps/${{ matrix.app }}
          file: apps/${{ matrix.app }}/Dockerfile
          push: false
          platforms: linux/amd64
          tags: ghcr.io/chillincool/${{ matrix.app }}:pr-${{ github.run_id }}
          outputs: type=docker,dest=/tmp/${{ matrix.app }}-image.tar

      - name: Load image into Docker
        run: docker load --input /tmp/${{ matrix.app }}-image.tar

      - name: Clean up image tar (free disk space)
        run: rm -f /tmp/${{ matrix.app }}-image.tar

      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run container tests
        env:
          TEST_IMAGE: ghcr.io/chillincool/${{ matrix.app }}:pr-${{ github.run_id }}
        run: |
          cd testhelpers
          go mod tidy
          go test -v ../apps/${{ matrix.app }}/container_test.go

  # Push workflow: multi-arch build + push, only on main (full build)
  push-images:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.detect-changes.outputs.apps != '[]'
    strategy:
      fail-fast: false
      matrix:
        app: ${{fromJson(needs.detect-changes.outputs.apps)}}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU (multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push image (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: apps/${{ matrix.app }}
          file: apps/${{ matrix.app }}/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: |
            ghcr.io/chillincool/${{ matrix.app }}:latest
            ghcr.io/chillincool/${{ matrix.app }}:${{ github.sha }}

      - name: Install Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Run container tests against pushed image
        env:
          TEST_IMAGE: ghcr.io/chillincool/${{ matrix.app }}:latest
        run: |
          cd testhelpers
          go mod tidy
          go test -v ../apps/${{ matrix.app }}/container_test.go
